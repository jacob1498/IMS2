<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All IC Attendance - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    
    /* Card content expand/collapse */
    .card-content.hidden { display: none; }
    .section-content.hidden { display: none !important; }
    /* Resizable box */
    .resizable-box { resize: both; overflow: auto; min-width: 300px; min-height: 200px; }
    /* Ensure modal is on top */
    .modal { z-index: 10001; }
    
    /* Fix tooltips inside modal */
    .modal-content .icon-btn[data-tooltip]::after { top: 100%; bottom: auto; margin-top: 8px; margin-bottom: 0; }
    .modal-content .icon-btn[data-tooltip]::before { top: 100%; bottom: auto; margin-top: 3px; margin-bottom: 0; border-top-color: transparent; border-bottom-color: #2c3e50; }
    
    /* Sortable headers */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f1f1f1; }
    .sort-icon { margin-left: 5px; font-size: 10px; }
    body.dark-mode th.sortable:hover { background-color: #333; }
    
    .editable-time { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
    .editable-time:hover { color: #2752a7; }

    /* Excel-like Report Table */
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px; /* Smaller font */
        border: 1px solid #ccc; table-layout: fixed;
    }
    .report-table th, .report-table td {
        border: 1px solid #ccc; /* Grid lines */
        padding: 4px 6px; /* Compact padding */
        text-align: left;
    }
    .report-table th {
        background-color: #f0f0f0;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
    }
    .report-table tbody tr:nth-child(even) { background-color: #fafafa; }
    .report-table tr:hover { background-color: #eef6ff; }
    
    /* Dark mode overrides */
    body.dark-mode .report-table { border-color: #444; }
    body.dark-mode .report-table th, body.dark-mode .report-table td { border-color: #444; color: #e0e0e0; }
    body.dark-mode .report-table th { background-color: #2c2c2c; }
    body.dark-mode .report-table tbody tr:nth-child(even) { background-color: #1f1f1f; }
    body.dark-mode .report-table tr:hover { background-color: #333; }

    /* Tabs */
    .att-tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
    .att-tab { padding: 8px 16px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: transparent; color: #666; font-weight: 600; font-size: 13px; }
    .att-tab:hover { color: #2752a7; background: #f9f9f9; }
    .att-tab.active { border-color: #ccc; border-bottom-color: #fff; background: #fff; color: #2752a7; border-radius: 4px 4px 0 0; margin-bottom: -1px; }
    body.dark-mode .att-tab { color: #aaa; }
    body.dark-mode .att-tab:hover { color: #fff; background: #333; }
    body.dark-mode .att-tab.active { border-color: #444; border-bottom-color: #1e1e1e; background: #1e1e1e; color: #fff; }
    body.dark-mode .att-tabs { border-bottom-color: #444; }

    /* Summary Cards */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .summary-card { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eef2f6; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .summary-value { font-size: 24px; font-weight: bold; color: #2752a7; }
    .summary-label { font-size: 12px; color: #6c757d; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Flip Card Styles */
    .flip-container { perspective: 1000px; position: relative; margin-top: 20px; height: 80vh; min-height: 600px; }
    .flip-inner { transition: transform 0.6s; transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
    .flip-container.flipped .flip-inner { transform: rotateY(180deg); }
    .flip-front, .flip-back { 
        backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        border-radius: 8px; 
        display: flex; flex-direction: column;
    }
    .flip-front { z-index: 2; transform: rotateY(0deg); }
    .flip-back { transform: rotateY(180deg); }

    /* Floating Action Button */
    .fab-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #2752a7;
      color: white;
      border: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9999;
      transition: transform 0.2s, background-color 0.2s;
    }
    .fab-btn:hover {
      transform: scale(1.1);
      background-color: #1f4287;
    }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>
  
  <!-- Main App Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button onclick="window.location.href='homepage.html'" data-tooltip="Homepage">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="menu-text">Homepage</span>
        </button>
      </li>
       <li>
        <button data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu" style="display:block">
          <li><button onclick="window.location.href='all_ic_attendance.html'" class="active"><span class="menu-text" >All IC Attendance</button></li>
          <li><button onclick="window.location.href='daily_cycle_count.html'">Daily Cycle Count</button></li>
        </ul>
      </li>
  </nav>

  <header>
    <h1>All IC Attendance</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <!-- Optional back button -->
      </div>
      <div class="nav-right">
        <div class="nav-user" id="nav-user">
          <a href="profile.html" title="Profile" style="text-decoration:none; margin-right: 4px;"><span id="nav-avatar" class="avatar small"></span></a>
          <button class="user-btn" id="user-btn"><span id="username-display"></span></button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; padding: 15px;">
      <strong style="color: var(--accent);">Global Date Filter:</strong>
      <label for="global-start-date">From:</label>
      <input type="date" id="global-start-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <label for="global-end-date">To:</label>
      <input type="date" id="global-end-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <button id="apply-global-filter" class="icon-btn" title="Apply Filter" style="background: #2752a7; color: white;">Filter</button>
      <button id="clear-global-filter" class="icon-btn" title="Clear Filter">Clear</button>
      
      <button id="counter-timestamp-btn" class="icon-btn" title="Counter Timestamp" style="margin-left: 10px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Timestamp
      </button>
      <button id="reports-menu-btn" class="icon-btn" title="Reports" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Reports
      </button>
      <button id="set-requirements-btn" class="icon-btn" title="Set Requirements" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> Requirements
      </button>
      <button id="ic-master-btn" class="icon-btn" title="IC User ID Master" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> IC Master
      </button>
      <div style="display:flex; align-items:center; gap:5px; margin-left:10px; border-left:1px solid #ccc; padding-left:10px;">
          <input type="checkbox" id="auto-refresh-check" title="Auto Refresh every 15s">
          <label for="auto-refresh-check" style="font-size:13px; cursor:pointer;">Auto Refresh</label>
      </div>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-value" id="summary-1st">0</div>
            <div class="summary-label">1st Shift</div>
        </div>
        <div class="summary-card">
            <div class="summary-value" id="summary-2nd">0</div>
            <div class="summary-label">2nd Shift</div>
        </div>
        <div class="summary-card">
            <div class="summary-value" id="summary-3rd">0</div>
            <div class="summary-label">3rd Shift</div>
        </div>
        <div class="summary-card">
            <div class="summary-value" id="summary-total">0</div>
            <div class="summary-label">Total Attendance</div>
        </div>
    </div>

    <div class="flip-container" id="attendance-flip-container">
      <div class="flip-inner">
      <div class="flip-front card resizable-box" id="attendance-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0;">Attendance Sheet</h2>
            <button id="view-chart-btn" class="icon-btn" title="View Analysis" style="background:#6f42c1; color:white; font-size:12px; padding:4px 8px;">View Analysis</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="att-filter-role" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
                <option value="">All Roles</option>
                <option value="IC Support">IC Support</option>
                <option value="Warehouse">Warehouse</option>
                <option value="Admin">Admin</option>
                <option value="Management">Management</option>
            </select>
            <select id="att-filter-status" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
                <option value="">All Statuses</option>
                <option value="Full-time">Full-time</option>
                <option value="Temporary slide to Other task">Temporary slide to Other task</option>
            </select>
            <div id="att-filter-area-wrapper" style="position:relative; display:inline-block;">
                <button id="att-filter-area-btn" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#fff; color:black; cursor:pointer; min-width:150px; text-align:left; display:flex; justify-content:space-between; align-items:center;">
                    <span id="att-filter-area-text">All Job Descriptions</span>
                    <span style="font-size:10px; margin-left:5px;">‚ñº</span>
                </button>
                <div id="att-filter-area-dropdown" style="display:none; position:absolute; top:100%; left:0; background:#fff; border:1px solid #ccc; border-radius:4px; padding:10px; z-index:1000; min-width:200px; box-shadow:0 4px 8px rgba(0,0,0,0.1); max-height:300px; overflow-y:auto;">
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Cycle Counter"> Cycle Counter</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="TL"> TL</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="OIC"> OIC</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Encoder"> Encoder</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="SBD Checker"> SBD Checker</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="RTV"> RTV</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Damaged Checker"> Damaged Checker</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="B1T1 Checker"> B1T1 Checker</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Validator"> Validator</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="HVI Support"> HVI Support</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Projects"> Projects</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="HO-Cancelled"> HO-Cancelled</label>
                    <div style="border-top:1px solid #eee; margin-top:5px; padding-top:5px; text-align:right;">
                        <button id="att-filter-area-clear" style="padding:4px 8px; background:#eee; color:#333; border:none; border-radius:4px; font-size:12px; margin-right:5px;">Clear</button>
                        <button id="att-filter-area-apply" style="padding:4px 8px; background:#2752a7; color:white; border:none; border-radius:4px; font-size:12px;">Apply</button>
                    </div>
                </div>
            </div>
            <input type="text" id="att-search" placeholder="Search name..." style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <button id="print-att-btn" class="icon-btn" title="Print List">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            </button>
            <button id="delete-selected-att-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
            </button>
            <button id="export-att-btn" class="icon-btn" title="Export CSV" style="margin-right:5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            <button id="add-att-btn" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add Entry
            </button>
        </div>
      </div>
      <div class="card-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
      <div class="att-tabs">
          <button class="att-tab active" data-shift="">All Shifts</button>
          <button class="att-tab" data-shift="1st Shift-(6am-2pm)">1st Shift</button>
          <button class="att-tab" data-shift="2nd Shift-(2pm-10pm)">2nd Shift</button>
          <button class="att-tab" data-shift="3rd Shift-(10pm-6am)">3rd Shift</button>
      </div>
      <div style="overflow: auto; flex: 1;">
          <table id="attendance-table" class="report-table">
              <thead>
                  <tr>
                      <th style="width: 30px;"><input type="checkbox" id="select-all-att" title="Select All"></th>
                      <th class="sortable" data-sort="date" style="width: 80px;">Date <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="userId" style="width: 60px;">User ID <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="shift" style="width: 100px;">Shift <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="name" style="width: 120px;">Name <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="role" style="width: 80px;">Role <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="area" style="width: 100px;">Job Description <span class="sort-icon"></span></th>
                      <th style="width: 60px;">Time In</th>
                      <th style="width: 60px;">Break Out</th>
                      <th style="width: 60px;">Break In</th>
                      <th style="width: 60px;">Time Out</th>
                      <th class="sortable" data-sort="duration" style="width: 60px;">Duration <span class="sort-icon"></span></th>
                      <th style="width: 80px;">Status</th>
                      <th style="width: 100px;">Notes</th>
                      <th style="width: 60px;">Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                  <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #eef2f6;">
                      <td colspan="15" style="text-align: right; padding: 10px;">Total Records: <span id="att-total-count">0</span></td>
                  </tr>
              </tfoot>
          </table>
      </div>
      <div id="att-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-top: 1px solid #eee;">
        <div style="display:flex; align-items:center; gap:8px;">
            <label for="att-rows-per-page" style="font-size:13px; color:var(--muted);">Rows:</label>
            <select id="att-rows-per-page" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #d6dbe6;"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option><option value="100">100</option></select>
        </div>
        <span id="att-page-info" style="font-size: 13px; font-weight: 600; color: var(--muted);"></span>
        <div style="display:flex; gap:8px;">
            <button id="att-prev-page" class="icon-btn" title="Previous">‚Äπ</button>
            <button id="att-next-page" class="icon-btn" title="Next">‚Ä∫</button>
        </div>
      </div>
      </div>
    </div>

    <div class="flip-back card resizable-box" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">Sub Role Analysis</h2>
            <button id="view-table-btn" class="icon-btn" title="Back to Table">‚Ü© Back to Table</button>
        </div>
        <div id="sub-role-dashboard" style="flex:1; position:relative; min-height:0; overflow:auto;">
            <!-- Analysis content -->
        </div>
    </div>
    </div>
    </div>
  </main>

  <!-- Attendance Modal -->
  <div id="att-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0" id="att-modal-title">Add Attendance</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <form id="att-modal-form" style="display: grid; gap: 15px;">
            <input type="hidden" id="att-edit-id">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-date">Date</label>
                    <input type="date" id="att-date" required style="width:100%">
                </div>
                <div>
                    <label for="att-shift">Shift</label>
                    <select id="att-shift" required style="width:100%">
                        <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                        <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                        <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                <div>
                    <label for="att-user-id">User ID</label>
                    <input type="text" id="att-user-id" placeholder="ID" style="width:100%">
                </div>
                <div>
                    <label for="att-name">Name</label>
                    <input type="text" id="att-name" required placeholder="Enter Name" style="width:100%" list="att-name-list" autocomplete="off">
                    <datalist id="att-name-list"></datalist>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-role">Role</label>
                    <select id="att-role" style="width:100%">
                        <option value="IC Support">IC Support</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Admin">Admin</option>
                        <option value="Management">Management</option>
                    </select>
                </div>
                <div>
                    <label for="att-area">Job Description</label>
                    <select id="att-area" style="width:100%">
                        <option value="TL">TL</option>
                        <option value="OIC">OIC</option>
                        <option value="Encoder">Encoder</option>
                        <option value="SBD Checker">SBD Checker</option>
                        <option value="RTV">RTV</option>
                        <option value="Damaged Checker">Damaged Checker</option>
                        <option value="B1T1 Checker">B1T1 Checker</option>
                        <option value="Validator">Validator</option>
                        <option value="HVI Support">HVI Support</option>
                        <option value="Cycle Counter">Cycle Counter</option>
                        <option value="Projects">Projects</option>
                        <option value="HO-Cancelled">HO-Cancelled</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-time-in">Time In</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-time-in" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-time-in" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="att-time-out">Time Out</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-time-out" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-time-out" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="att-notes">Notes (Optional)</label>
                    <input type="text" id="att-notes" style="width:100%" placeholder="Enter notes">
                </div>
            </div>
            <div>
                <label for="att-status">Status</label>
                <select id="att-status" style="width:100%">
                    <option value="Full-time">Full-time</option>
                    <option value="Temporary slide to Other task">Temporary slide to Other task</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-break-out">Break Out</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-break-out" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-break-out" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="att-break-in">Break In</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-break-in" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-break-in" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="text-align:right; margin-top:10px; border-top: 1px solid #eee; padding-top: 15px;">
                <button type="button" class="icon-btn close-modal" style="margin-right:5px; border: 1px solid #ccc; padding: 8px 16px;">Close</button>
                <button type="submit" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 16px;">Save</button>
            </div>
        </form>
    </div>
  </div>

  <!-- Counter Timestamp Modal -->
  <div id="timestamp-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="width: 98vw; max-width: 1800px; height: 90vh; margin: 20px auto; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Counter Timestamp</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        
        <div style="display:flex; gap: 20px; flex:1; overflow:hidden;">
            <!-- Left Column: Controls & Tables -->
            <div style="flex: 2; display:flex; flex-direction:column; gap:10px; overflow-y:auto; padding-right:10px;">
                <!-- Controls -->
                <div>
                    <div style="margin-bottom:10px;">
                    <label for="ts-user-id" style="font-weight:bold;">User ID / Name</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="ts-user-id" placeholder="User ID" style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px;">
                        <input type="text" id="ts-user-name-display" placeholder="Name" readonly style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px; background:#f9f9f9;">
                    </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                        <button id="btn-break-start-main" class="icon-btn" style="background:#f1c40f; color:white; padding:10px; font-weight:bold; justify-content:center;">Break Out</button>
                        <button id="btn-break-end-main" class="icon-btn" style="background:#f39c12; color:white; padding:10px; font-weight:bold; justify-content:center;">Break In</button>
                        <button id="btn-nsw" class="icon-btn" style="background:#9b59b6; color:white; padding:10px; font-weight:bold; justify-content:center;">NSW</button>
                        <button id="btn-time-out" class="icon-btn" style="background:#34495e; color:white; padding:10px; font-weight:bold; justify-content:center;">Time Out</button>
                    </div>
                </div>

                <!-- Table 1: Today's Logs -->
                <div class="card" style="margin:0; padding:10px; display:flex; flex-direction:column; max-height:400px;">
                    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="icon-btn toggle-section-btn" title="Toggle Table" style="padding:2px; height:24px; width:24px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            <h4 style="margin:0;">Today's Logs</h4>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <select id="ts-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                            </select>
                            <input type="text" id="ts-filter-user" placeholder="Search User..." style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
                            <label style="font-size:12px; cursor:pointer;"><input type="checkbox" id="ts-show-active"> Active Only</label>
                            <button id="ts-delete-selected-btn" class="icon-btn" title="Delete Selected" style="padding: 2px 6px; font-size: 12px; color:#d9534f; display:none;">Del Sel</button>
                            <button id="ts-purge-all-btn" class="icon-btn" title="Permanently Delete All Shown" style="padding: 2px 6px; font-size: 12px; background:#c0392b; color:white; border-color:#c0392b;">Purge All</button>
                            <button id="ts-export-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                        </div>
                    </div>
                    <div class="section-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table id="timestamp-table" style="width:100%; border-collapse:collapse; font-size:12px;">
                            <thead>
                                <tr style="background:#f9f9f9; border-bottom:1px solid #eee; position:sticky; top:0;">
                                    <th style="padding:8px; text-align:left; width:30px;"><input type="checkbox" id="ts-select-all"></th>
                                    <th style="padding:8px; text-align:left;">User ID</th>
                                    <th style="padding:8px; text-align:left;">Name</th>
                                    <th style="padding:8px; text-align:left;">Area Type</th>
                                    <th style="padding:8px; text-align:left;">Shift</th>
                                    <th style="padding:8px; text-align:left;">Start Time</th>
                                    <th style="padding:8px; text-align:left;">End Time</th>
                                    <th style="padding:8px; text-align:left;">Duration</th>
                                    <th style="padding:8px; text-align:left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="ts-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding-top:5px; margin-top:5px; border-top: 1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <label for="ts-rows-per-page" style="font-size:11px; color:#666;">Rows:</label>
                            <select id="ts-rows-per-page" style="padding: 2px 4px; font-size:11px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <span id="ts-page-info" style="font-size: 11px; font-weight: 600; color: #666;"></span>
                        <div style="display:flex; gap:5px;">
                            <button id="ts-prev-page" class="icon-btn" title="Previous" style="padding:2px 6px; font-size:12px;">‚Äπ</button>
                            <button id="ts-next-page" class="icon-btn" title="Next" style="padding:2px 6px; font-size:12px;">‚Ä∫</button>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Table 2: Break Log -->
                <div class="card" style="margin:0; padding:10px; display:flex; flex-direction:column; max-height:300px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="icon-btn toggle-section-btn" title="Toggle Table" style="padding:2px; height:24px; width:24px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            <h4 style="margin:0;">Break Log</h4>
                        </div>
                        <div style="display:flex; gap:5px;">
                             <select id="break-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 80px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                             </select>
                             <label style="font-size:12px; cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="break-show-active"> Active</label>
                             <input type="datetime-local" id="manual-break-time" style="padding:4px; font-size:11px; border:1px solid #ccc; border-radius:4px; width:130px;" title="Manual Break Time">
                             <button id="btn-break-start" class="icon-btn" style="background:#f1c40f; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">Start Break</button>
                             <button id="btn-break-end" class="icon-btn" style="background:#f39c12; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">End Break</button>
                             <button id="break-delete-selected-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; display:none;">Del Sel</button>
                             <button id="break-export-btn" class="icon-btn" title="Export CSV" style="padding:4px 8px; font-size:12px; font-weight:bold;">Export</button>
                             <button id="btn-break-delete-all" class="icon-btn" title="Delete All Breaks" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; margin-left:5px;">üóë All</button>
                        </div>
                    </div>
                    <div class="section-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee;">
                        <table id="break-log-table" style="width:100%; font-size:12px; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f9f9f9; position:sticky; top:0;">
                                    <th style="padding:5px; text-align:left; width:30px;"><input type="checkbox" id="break-select-all"></th>
                                    <th style="padding:5px; text-align:left;">User</th>
                                    <th style="padding:5px; text-align:left;">Name</th>
                                    <th style="padding:5px; text-align:left;">Shift</th>
                                    <th style="padding:5px; text-align:left;">Role</th>
                                    <th style="padding:5px; text-align:left;">Break Out</th>
                                    <th style="padding:5px; text-align:left;">Break In</th>
                                    <th style="padding:5px; text-align:left;">Duration</th>
                                    <th style="padding:5px; text-align:left;">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                </div>

                <!-- Table 3: Inactive Users -->
                <div class="card" style="margin:0; padding:10px; display:flex; flex-direction:column; max-height:300px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="icon-btn toggle-section-btn" title="Toggle Table" style="padding:2px; height:24px; width:24px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            <h4 style="margin:0;">Inactive Users</h4>
                        </div>
                        <button id="ts-export-inactive-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                    </div>
                    <div class="section-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee;">
                        <table id="inactive-users-table" style="width:100%; font-size:12px; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f9f9f9; position:sticky; top:0;">
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('userId')">User <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('name')">Name <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('shift')">Shift <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('role')">Role <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('lastEnd')">Last End Count <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:center; width:40px;">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- Right Column: Analytics -->
            <div style="flex: 1; display:flex; flex-direction:column; border-left:1px solid #eee; padding-left:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;">Analytics Overview</h4>
                    <input type="date" id="ts-analytics-date-filter" style="padding:2px 5px; border:1px solid #ccc; border-radius:4px; font-size:12px; color:#333;" title="Filter Analytics Date">
                </div>
                <div id="ts-analytics-content" style="flex: 1; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
  </div>

  <!-- Start Count Area Selection Modal -->
  <div id="start-area-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Area</h3>
        <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-bin-type="Reserved" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">üì¶</div>
                <div style="font-weight:bold; margin-top:10px;">Reserved Bin</div>
            </div>
            <div class="card area-card" data-bin-type="Pick Bin" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">üõí</div>
                <div style="font-weight:bold; margin-top:10px;">Pick Bin</div>
            </div>
        </div>
        <button id="cancel-start-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Cancel</button>
    </div>
  </div>

  <!-- Warehouse Area Selection Modal -->
  <div id="warehouse-area-modal" class="modal hidden" style="z-index: 10016;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Warehouse Area</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-warehouse-area="Coldroom" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">‚ùÑÔ∏è</div>
                <div style="font-weight:bold; margin-top:10px;">Coldroom</div>
            </div>
            <div class="card area-card" data-warehouse-area="Ecom 2" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">üåê</div>
                <div style="font-weight:bold; margin-top:10px;">Ecom 2</div>
            </div>
            <div class="card area-card" data-warehouse-area="Storage" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">üóÑÔ∏è</div>
                <div style="font-weight:bold; margin-top:10px;">Storage</div>
            </div>
            <div class="card area-card" data-warehouse-area="Pallet Picking" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">üèóÔ∏è</div>
                <div style="font-weight:bold; margin-top:10px;">Pallet Picking</div>
            </div>
        </div>
        <button id="cancel-warehouse-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Back</button>
    </div>
  </div>

  <!-- Reports Selection Modal -->
  <div id="reports-modal" class="modal hidden" style="z-index: 10020;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Select Report</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center; justify-content:center; background:#f9f9f9; padding:10px; border-radius:4px;">
            <div style="text-align:left;">
                <label style="font-size:11px; display:block; font-weight:bold;">From</label>
                <input type="date" id="rep-start-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
            </div>
            <div style="text-align:left;">
                <label style="font-size:11px; display:block; font-weight:bold;">To</label>
                <input type="date" id="rep-end-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
            </div>
        </div>
        <div style="display:grid; gap:10px;">
            <button id="rep-sessions-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Counter Sessions (CSV)
            </button>
            <button id="rep-attendance-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Attendance List (CSV)
            </button>
            <button id="rep-breaklog-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Break Logs (CSV)
            </button>
            <button id="rep-inactive-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                Inactive Users (CSV)
            </button>
        </div>
    </div>
  </div>

  <!-- Supervisor Delete Modal -->
  <div id="supervisor-delete-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px;">
      <h3 id="supervisor-modal-title">Confirm Deletion</h3>
      <p>You are about to delete <strong id="supervisor-delete-count">0</strong> records.</p>
      <p class="muted">This action cannot be undone. Please enter Supervisor Code to proceed.</p>
      <div style="margin: 15px 0;">
        <label for="supervisor-code" style="display:block; margin-bottom:5px; font-weight:bold;">Supervisor Code</label>
        <input type="password" id="supervisor-code" style="width:100%;" placeholder="Enter code">
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button type="button" class="icon-btn close-modal">Cancel</button>
        <button type="button" id="confirm-supervisor-delete-btn" class="icon-btn" style="background:#d9534f; color:white;">Confirm Delete</button>
      </div>
    </div>
  </div>

  <!-- Edit Timestamp Modal -->
  <div id="edit-time-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto;">
        <h3 style="margin-top:0">Edit Timestamp</h3>
        <input type="hidden" id="edit-time-log-id">
        <div style="margin-bottom:15px;">
            <label for="edit-time-input" style="font-weight:bold;">New Date & Time:</label>
            <input type="datetime-local" id="edit-time-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button id="cancel-edit-time-btn" class="icon-btn" style="border:1px solid #ccc;">Cancel</button>
            <button id="save-edit-time-btn" class="icon-btn" style="background:#2752a7; color:white;">Save</button>
        </div>
    </div>
  </div>

  <!-- Requirements Modal -->
  <div id="req-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 800px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Set Shift Requirements (Daily)</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="margin-bottom:10px;">
            <select id="req-role-filter" style="padding:6px; border:1px solid #ccc; border-radius:4px; width:100%;"><option value="">All Sub Roles</option></select>
        </div>
        <div style="overflow-x:auto; max-height: 60vh;">
            <table class="report-table" id="req-table">
                <thead>
                    <tr>
                        <th>Sub Role</th>
                        <th>1st Shift</th>
                        <th>2nd Shift</th>
                        <th>3rd Shift</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <input type="file" id="import-req-file" accept=".csv" style="display:none;">
            <button id="import-req-btn" class="icon-btn" style="background: #fff; color: #333; border: 1px solid #ccc; padding: 8px 16px; margin-right: 5px;">Import CSV</button>
            <button id="export-req-btn" class="icon-btn" style="background: #fff; color: #333; border: 1px solid #ccc; padding: 8px 16px; margin-right: 5px;">Export CSV</button>
            <button id="save-req-btn" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 16px;">Save Requirements</button>
        </div>
    </div>
  </div>

  <!-- IC Master Modal -->
  <div id="ic-master-modal" class="modal hidden" style="z-index: 10025;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 600px; margin: 50px auto; display:flex; flex-direction:column; max-height:85vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">IC User ID Master (IC Support)</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr 1fr auto; gap:5px; align-items:end; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
            <div>
                <label style="font-size:11px; font-weight:bold;">User ID</label>
                <input type="text" id="ic-master-id" style="width:100%; padding:5px; text-transform:uppercase;" placeholder="ID">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Name</label>
                <input type="text" id="ic-master-name" style="width:100%; padding:5px; text-transform:uppercase;" placeholder="Name">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Role</label>
                <select id="ic-master-role" style="width:100%; padding:5px;"><option value="IC Support">IC Support</option><option value="IC Back up">IC Back up</option><option value="Warehouse">Warehouse</option><option value="Admin">Admin</option><option value="Management">Management</option></select>
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Job Desc</label>
                <select id="ic-master-job" style="width:100%; padding:5px;"><option value="">-</option></select>
            </div>
            <button id="save-ic-master-btn" class="icon-btn" style="background:#2752a7; color:white; height:28px; padding:0 10px;">Save</button>
        </div>

        <div style="margin-bottom:10px;">
            <input type="text" id="ic-master-search" placeholder="Search..." style="padding:6px; border:1px solid #ccc; border-radius:4px; width: 100%;">
        </div>
        <div style="flex:1; overflow:auto; border:1px solid #eee;">
            <table id="ic-master-table" class="report-table" style="width:100%;">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="userId" style="position:sticky; top:0; z-index:1;">User ID <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="name" style="position:sticky; top:0; z-index:1;">Name <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="role" style="position:sticky; top:0; z-index:1;">Role <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="jobDescription" style="position:sticky; top:0; z-index:1;">Job Description <span class="sort-icon"></span></th>
                        <th style="position:sticky; top:0; z-index:1;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="ic-master-pagination" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-top:1px solid #eee;">
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px;">Rows:</label>
                <select id="ic-master-rows" style="padding:2px; font-size:12px;">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <span id="ic-master-page-info" style="font-size:12px; color:#666;"></span>
            <div style="display:flex; gap:5px;">
                <button id="ic-master-prev" class="icon-btn" style="padding:2px 6px;">&lt;</button>
                <button id="ic-master-next" class="icon-btn" style="padding:2px 6px;">&gt;</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Floating Quick Time In Widget -->
  <div id="quick-time-in-widget" class="card" style="position: fixed; bottom: 20px; right: 20px; width: 300px; padding: 0; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid #ccc; background: white; display:flex; flex-direction:column;">
      <div id="quick-widget-header" style="padding:10px; background:#f1f1f1; border-bottom:1px solid #eee; cursor:move; display:flex; justify-content:space-between; align-items:center; border-radius: 8px 8px 0 0;">
          <h4 style="margin:0; color:#2752a7; font-size:14px;">Quick Time In</h4>
      </div>
      <div style="padding:10px 15px 15px 15px; display:flex; flex-direction:column; gap:10px;">
          <div id="quick-widget-clock" style="text-align:center; font-size:12px; color:#666; margin-bottom:5px; font-weight:bold;"></div>
          <div style="display:flex; gap:5px;">
              <input type="text" id="quick-user-id" placeholder="User ID" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; text-transform:uppercase;">
              <button id="quick-time-in-btn" class="icon-btn" style="background:#2ecc71; color:white; font-weight:bold; padding: 0 12px;">GO</button>
              <button id="quick-clear-btn" class="icon-btn" style="background:#f0f0f0; color:#333; border:1px solid #ccc; padding: 0 8px;" title="Clear">C</button>
          </div>
          <input type="text" id="quick-user-name" placeholder="Name" readonly style="padding:8px; border:1px solid #eee; border-radius:4px; background:#f9f9f9; color:#555;">
          <input type="text" id="quick-user-role" placeholder="Role" readonly style="padding:8px; border:1px solid #eee; border-radius:4px; background:#f9f9f9; color:#555;">
          <button id="manual-add-btn" style="margin-top:5px; font-size:12px; background:none; border:none; color:#2752a7; text-decoration:underline; cursor:pointer; text-align:left; padding:0;">Manual Entry (+)</button>
      </div>
  </div>

  <div id="toast-notification" class="toast"></div>
  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';

    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEY_ATTENDANCE = 'ims_daily_attendance_v1';
        const STORAGE_KEY_TIMESTAMPS = 'ims_all_ic_timestamps_v1';
        
        let attCurrentPage = 1;
        let attItemsPerPage = 20;
        let attSortField = 'date';
        let attSortDirection = 'desc';
        let tsSortField = 'startTime';
        let tsSortDirection = 'desc';
        let currentShiftFilter = '';
        
        // Elements
        const attendanceTableBody = document.querySelector('#attendance-table tbody');
        const attModal = document.getElementById('att-modal');
        const attForm = document.getElementById('att-modal-form');
        const addAttBtn = document.getElementById('add-att-btn');
        const exportAttBtn = document.getElementById('export-att-btn');
        const printAttBtn = document.getElementById('print-att-btn');
        const attSearchInput = document.getElementById('att-search');
        const attFilterRole = document.getElementById('att-filter-role');
        const deleteSelectedAttBtn = document.getElementById('delete-selected-att-btn');
        const selectAllAtt = document.getElementById('select-all-att');
        
        const globalStartDate = document.getElementById('global-start-date');
        const globalEndDate = document.getElementById('global-end-date');
        const applyGlobalFilterBtn = document.getElementById('apply-global-filter');
        const clearGlobalFilterBtn = document.getElementById('clear-global-filter');
        
        // Timestamp Elements
        const timestampBtn = document.getElementById('counter-timestamp-btn');
        const timestampModal = document.getElementById('timestamp-modal');
        const tsUserIdInput = document.getElementById('ts-user-id');
        const btnStartCount = document.getElementById('btn-start-count');
        const btnBreakStartMain = document.getElementById('btn-break-start-main');
        const btnBreakEndMain = document.getElementById('btn-break-end-main');
        const btnEndCount = document.getElementById('btn-end-count');
        const btnNSW = document.getElementById('btn-nsw');
        const btnBreakStart = document.getElementById('btn-break-start');
        const btnBreakEnd = document.getElementById('btn-break-end');
        const btnTimeOut = document.getElementById('btn-time-out');
        const timestampTableBody = document.querySelector('#timestamp-table tbody');
        const tsExportBtn = document.getElementById('ts-export-btn');
        const tsFilterUser = document.getElementById('ts-filter-user');
        const tsShiftFilter = document.getElementById('ts-shift-filter');
        const tsExportInactiveBtn = document.getElementById('ts-export-inactive-btn');
        const tsPurgeAllBtn = document.getElementById('ts-purge-all-btn');
        const tsDeleteSelectedBtn = document.getElementById('ts-delete-selected-btn');
        const tsSelectAll = document.getElementById('ts-select-all');
        const tsShowActive = document.getElementById('ts-show-active');
        const tsAnalyticsDateFilter = document.getElementById('ts-analytics-date-filter');
        
        // Reports
        const reportsMenuBtn = document.getElementById('reports-menu-btn');
        const reportsModal = document.getElementById('reports-modal');
        const repAttendanceBtn = document.getElementById('rep-attendance-btn');
        const repBreaklogBtn = document.getElementById('rep-breaklog-btn');
        const repInactiveBtn = document.getElementById('rep-inactive-btn');
        const repSessionsBtn = document.getElementById('rep-sessions-btn');
        
        // Requirements
        const reqModal = document.getElementById('req-modal');
        const setReqBtn = document.getElementById('set-requirements-btn');
        const saveReqBtn = document.getElementById('save-req-btn');
        const exportReqBtn = document.getElementById('export-req-btn');
        const importReqBtn = document.getElementById('import-req-btn');
        const importReqFile = document.getElementById('import-req-file');
        const viewChartBtn = document.getElementById('view-chart-btn');
        const viewTableBtn = document.getElementById('view-table-btn');
        const flipContainer = document.getElementById('attendance-flip-container');

        // IC Master
        const icMasterBtn = document.getElementById('ic-master-btn');
        const icMasterModal = document.getElementById('ic-master-modal');
        const icMasterSearch = document.getElementById('ic-master-search');

        // Start Area Modal
        const startAreaModal = document.getElementById('start-area-modal');
        const warehouseAreaModal = document.getElementById('warehouse-area-modal');
        const cancelStartAreaBtn = document.getElementById('cancel-start-area-btn');
        const cancelWarehouseAreaBtn = document.getElementById('cancel-warehouse-area-btn');
        let selectedBinType = '';
        
        // Supervisor Delete
        const supervisorDeleteModal = document.getElementById('supervisor-delete-modal');
        const confirmSupervisorDeleteBtn = document.getElementById('confirm-supervisor-delete-btn');
        let supervisorDeleteCallback = null;

        // Edit Time
        const editTimeModal = document.getElementById('edit-time-modal');
        const cancelEditTimeBtn = document.getElementById('cancel-edit-time-btn');
        const saveEditTimeBtn = document.getElementById('save-edit-time-btn');

        // Helper Functions
        function getAttendanceData() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_ATTENDANCE) || '[]'); } catch (e) { return []; }
        }
        function saveAttendanceData(data) {
            localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(data));
        }
        function getTimestamps() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TIMESTAMPS) || '[]'); } catch(e) { return []; }
        }
        function saveTimestamps(data) {
            localStorage.setItem(STORAGE_KEY_TIMESTAMPS, JSON.stringify(data));
        }
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }
        function getDuration(start, end) {
            if (!start || !end) return '-';
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (minutes < 0) minutes += 24 * 60;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return (h > 0 ? h + 'h ' : '') + m + 'm';
        }
        function getShiftFromTimestamp(ts) {
            const d = new Date(ts);
            if (isNaN(d.getTime())) return { date: '', shift: '' };
            const h = d.getHours();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            let dateStr = `${year}-${month}-${day}`;
            let shift = '';
            if (h >= 6 && h < 14) shift = '1st Shift-(6am-2pm)';
            else if (h >= 14 && h < 22) shift = '2nd Shift-(2pm-10pm)';
            else {
                shift = '3rd Shift-(10pm-6am)';
                if (h < 6) {
                    const prev = new Date(d);
                    prev.setDate(d.getDate() - 1);
                    const pYear = prev.getFullYear();
                    const pMonth = String(prev.getMonth() + 1).padStart(2, '0');
                    const pDay = String(prev.getDate()).padStart(2, '0');
                    dateStr = `${pYear}-${pMonth}-${pDay}`;
                }
            }
            return { date: dateStr, shift };
        }

        // --- Attendance Logic ---
        
        function getFilteredAttendanceData(ignoreShift = false) {
            let data = getAttendanceData();
            if (globalStartDate.value || globalEndDate.value) {
                const start = globalStartDate.value ? new Date(globalStartDate.value) : null;
                if (start) start.setHours(0,0,0,0);
                const end = globalEndDate.value ? new Date(globalEndDate.value) : null;
                if (end) end.setHours(23,59,59,999);
                data = data.filter(item => {
                    const itemDate = new Date(item.date);
                    return (!start || itemDate >= start) && (!end || itemDate <= end);
                });
            }
            const searchTerm = attSearchInput ? attSearchInput.value.toLowerCase() : '';
            if (searchTerm) {
                data = data.filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.role && item.role.toLowerCase().includes(searchTerm)) ||
                    (item.area && item.area.toLowerCase().includes(searchTerm))
                );
            }
            if (attFilterRole && attFilterRole.value) data = data.filter(item => item.role === attFilterRole.value);
            const selectedAreas = Array.from(document.querySelectorAll('.att-area-cb:checked')).map(cb => cb.value);
            if (selectedAreas.length > 0) {
                data = data.filter(item => selectedAreas.includes(item.area));
            }
            const statusFilter = document.getElementById('att-filter-status').value;
            if (statusFilter) {
                data = data.filter(item => (item.status || 'Full-time') === statusFilter);
            }
            if (!ignoreShift && currentShiftFilter) data = data.filter(item => item.shift === currentShiftFilter);
            
            data.sort((a, b) => {
                let valA = a[attSortField] || '';
                let valB = b[attSortField] || '';
                if (attSortField === 'duration') {
                    valA = getDuration(a.breakOut, a.breakIn);
                    valB = getDuration(b.breakOut, b.breakIn);
                }
                if (valA < valB) return attSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return attSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            return data;
        }

        function loadRequirements() {
            try { return JSON.parse(localStorage.getItem('ims_att_requirements_v1') || '{}'); } catch(e) { return {}; }
        }

        function updateSummary() {
            const data = getFilteredAttendanceData(true); // Ignore shift tab filter
            const reqs = loadRequirements();
            const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
            const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];

            const summary = {
                '1st Shift-(6am-2pm)': { act: 0, req: 0 },
                '2nd Shift-(2pm-10pm)': { act: 0, req: 0 },
                '3rd Shift-(10pm-6am)': { act: 0, req: 0 },
                'total': { act: 0, req: 0 }
            };
            
            data.forEach(item => {
                if (summary.hasOwnProperty(item.shift)) summary[item.shift].act++;
                summary.total.act++;
            });
            
            subRolesList.forEach(role => {
                shiftsList.forEach(shift => {
                    const val = parseInt(reqs[`${role}|${shift}`] || 0);
                    if(summary[shift]) summary[shift].req += val;
                    summary.total.req += val;
                });
            });
            
            const getPctHtml = (act, req) => {
                const pct = req > 0 ? Math.round((act / req) * 100) : 0;
                let color = '#e74c3c'; // red
                if (pct >= 100) color = '#2ecc71'; // green
                else if (pct >= 80) color = '#f1c40f'; // yellow
                // Only show percentage if there is a requirement
                if (req === 0 && act === 0) return '';
                return `<span style="font-size:14px; color:${color}; margin-left:5px;">(${pct}%)</span>`;
            };

            document.getElementById('summary-1st').innerHTML = `${summary['1st Shift-(6am-2pm)'].act} <span style="font-size:14px; color:#999;">/ ${summary['1st Shift-(6am-2pm)'].req}</span> ${getPctHtml(summary['1st Shift-(6am-2pm)'].act, summary['1st Shift-(6am-2pm)'].req)}`;
            document.getElementById('summary-2nd').innerHTML = `${summary['2nd Shift-(2pm-10pm)'].act} <span style="font-size:14px; color:#999;">/ ${summary['2nd Shift-(2pm-10pm)'].req}</span> ${getPctHtml(summary['2nd Shift-(2pm-10pm)'].act, summary['2nd Shift-(2pm-10pm)'].req)}`;
            document.getElementById('summary-3rd').innerHTML = `${summary['3rd Shift-(10pm-6am)'].act} <span style="font-size:14px; color:#999;">/ ${summary['3rd Shift-(10pm-6am)'].req}</span> ${getPctHtml(summary['3rd Shift-(10pm-6am)'].act, summary['3rd Shift-(10pm-6am)'].req)}`;
            document.getElementById('summary-total').innerHTML = `${summary.total.act} <span style="font-size:14px; color:#999;">/ ${summary.total.req}</span> ${getPctHtml(summary.total.act, summary.total.req)}`;
        }

        function renderAttendanceTable() {
            if (!attendanceTableBody) return;
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) attItemsPerPage = parseInt(attRowsPerPageSelect.value, 10);
            let data = getFilteredAttendanceData();
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / attItemsPerPage) || 1;
            if (attCurrentPage > totalPages) attCurrentPage = totalPages;
            const paginatedData = data.slice((attCurrentPage - 1) * attItemsPerPage, attCurrentPage * attItemsPerPage);

            const totalCountSpan = document.getElementById('att-total-count');
            if (totalCountSpan) totalCountSpan.textContent = totalItems;

            attendanceTableBody.innerHTML = '';
            const paginationControls = document.getElementById('att-pagination-controls');
            if (paginationControls) {
                document.getElementById('att-page-info').textContent = `Page ${attCurrentPage} of ${totalPages} (${totalItems} records)`;
                document.getElementById('att-prev-page').disabled = attCurrentPage <= 1;
                document.getElementById('att-next-page').disabled = attCurrentPage >= totalPages;
            }
            
            document.querySelectorAll('#attendance-table th.sortable .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeader = document.querySelector(`#attendance-table th[data-sort="${attSortField}"]`);
            if(activeHeader) activeHeader.querySelector('.sort-icon').textContent = attSortDirection === 'asc' ? '‚Üë' : '‚Üì';

            if (paginatedData.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="15" class="muted" style="text-align:center; padding: 20px;">No attendance records found.</td></tr>`;
                return;
            }
            paginatedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="att-row-checkbox" data-id="${item.id}"></td>
                    <td>${item.date}</td>
                    <td>${item.userId || '-'}</td>
                    <td>${item.shift}</td>
                    <td>${item.name}</td>
                    <td>${item.role || '-'}</td>
                    <td>${item.area || '-'}</td>
                    <td>${item.timeIn || '-'}</td>
                    <td>${item.breakOut || '-'}</td>
                    <td>${item.breakIn || '-'}</td>
                    <td>${item.timeOut || '-'}</td>
                    <td style="font-weight:bold; color:#555;">${getDuration(item.breakOut, item.breakIn)}</td>
                    <td>${item.status || '-'}</td>
                    <td>${item.notes || ''}</td>
                    <td>
                        <button class="icon-btn edit-att-btn" data-id="${item.id}" title="Edit" style="margin-right:5px">‚úé</button>
                        <button class="icon-btn delete-att-btn" data-id="${item.id}" title="Delete" style="color:#d9534f">&times;</button>
                    </td>
                `;
                attendanceTableBody.appendChild(tr);
            });
            updateSummary();
        }

        // Auto-fill User ID based on Name selection
        const attNameInput = document.getElementById('att-name');
        if (attNameInput) {
            attNameInput.addEventListener('input', () => {
                const val = attNameInput.value.trim();
                if (!val) return;
                const data = getAttendanceData();
                const user = data.slice().reverse().find(d => d.name && d.name.toLowerCase() === val.toLowerCase());
                if (user) {
                    if (user.userId) document.getElementById('att-user-id').value = user.userId;
                    if (user.role) document.getElementById('att-role').value = user.role;
                }
            });
        }

        // Auto-fill Name and Role based on User ID
        const attUserIdInput = document.getElementById('att-user-id');
        if (attUserIdInput) {
            attUserIdInput.addEventListener('input', () => {
                const val = attUserIdInput.value.trim();
                if (!val) return;
                const data = getAttendanceData();
                const user = data.slice().reverse().find(d => d.userId && d.userId.toLowerCase() === val.toLowerCase());
                if (user) {
                    if (user.name) document.getElementById('att-name').value = user.name;
                    if (user.role) document.getElementById('att-role').value = user.role;
                }
            });
        }

        function updateAttNameDatalist() {
            const list = document.getElementById('att-name-list');
            if (!list) return;
            list.innerHTML = '';
            const data = getAttendanceData();
            const uniqueNames = [...new Set(data.map(d => d.name).filter(n => n))].sort();
            uniqueNames.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                list.appendChild(opt);
            });
        }

        if (addAttBtn) {
            addAttBtn.addEventListener('click', () => {
                document.getElementById('att-modal-title').textContent = 'Add Attendance';
                attForm.reset();
                document.getElementById('att-edit-id').value = '';
                document.getElementById('att-date').valueAsDate = new Date();
                const now = new Date();
                const h = now.getHours();
                let shiftVal = '3rd Shift-(10pm-6am)';
                if (h >= 6 && h < 14) shiftVal = '1st Shift-(6am-2pm)';
                else if (h >= 14 && h < 22) shiftVal = '2nd Shift-(2pm-10pm)';
                document.getElementById('att-shift').value = shiftVal;
                
                const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const letter = letters.charAt(Math.floor(Math.random() * letters.length));
                const num = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                document.getElementById('att-user-id').value = letter + num;
                
                updateAttNameDatalist();
                attModal.classList.remove('hidden');
            });
        }

        if (attForm) {
            attForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('att-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('att-date').value,
                    shift: document.getElementById('att-shift').value,
                    userId: document.getElementById('att-user-id').value.trim(),
                    name: document.getElementById('att-name').value.trim().toUpperCase(),
                    role: document.getElementById('att-role').value,
                    area: document.getElementById('att-area').value,
                    timeIn: document.getElementById('att-time-in').value,
                    breakIn: document.getElementById('att-break-in').value,
                    breakOut: document.getElementById('att-break-out').value,
                    timeOut: document.getElementById('att-time-out').value,
                    status: document.getElementById('att-status').value,
                    notes: document.getElementById('att-notes').value.trim()
                };
                if(!newEntry.name) return;

                // Duplicate check: User ID and Name must be unique for the same shift
                const attendanceData = getAttendanceData();
                const existingId = attendanceData.find(a => 
                    a.date === newEntry.date && 
                    a.shift === newEntry.shift &&
                    a.userId === newEntry.userId &&
                    a.id !== newEntry.id
                );
                if (existingId) {
                    alert(`User ID ${newEntry.userId} is already assigned to this shift on ${newEntry.date}.`);
                    return;
                }
                const existingName = attendanceData.find(a => 
                    a.date === newEntry.date && 
                    a.shift === newEntry.shift &&
                    a.name === newEntry.name &&
                    a.id !== newEntry.id
                );
                if (existingName) {
                    alert(`Name "${newEntry.name}" is already assigned to this shift on ${newEntry.date}.`);
                    return;
                }

                let data = attendanceData;
                if (editId) {
                    const idx = data.findIndex(x => x.id === editId);
                    if (idx > -1) data[idx] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveAttendanceData(data);
                showToast('Attendance saved successfully!');
                attModal.classList.add('hidden');
                renderAttendanceTable();
                if(flipContainer.classList.contains('flipped')) renderSubRoleDashboard();
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;
                if (btn.classList.contains('delete-att-btn')) {
                    if(confirm('Remove this person?')) {
                        let data = getAttendanceData();
                        data = data.filter(item => item.id !== id);
                        saveAttendanceData(data);
                        renderAttendanceTable();
                        showToast('Attendance entry deleted');
                    }
                } else if (btn.classList.contains('edit-att-btn')) {
                    const data = getAttendanceData();
                    const item = data.find(x => x.id === id);
                    if (item) {
                        document.getElementById('att-modal-title').textContent = 'Edit Attendance';
                        document.getElementById('att-edit-id').value = item.id;
                        document.getElementById('att-date').value = item.date;
                        document.getElementById('att-user-id').value = item.userId || '';
                        document.getElementById('att-shift').value = item.shift;
                        document.getElementById('att-name').value = item.name;
                        document.getElementById('att-role').value = item.role;
                        document.getElementById('att-area').value = item.area;
                        document.getElementById('att-time-in').value = item.timeIn || '';
                        document.getElementById('att-break-out').value = item.breakOut;
                        document.getElementById('att-break-in').value = item.breakIn;
                        document.getElementById('att-time-out').value = item.timeOut || '';
                        document.getElementById('att-status').value = item.status || 'Full-time';
                        document.getElementById('att-notes').value = item.notes || '';
                        attModal.classList.remove('hidden');
                    }
                }
            });
        }

        // Mass Delete for Attendance
        function updateAttendanceActionButtons() {
            const selectedCount = document.querySelectorAll('.att-row-checkbox:checked').length;
            if (deleteSelectedAttBtn) {
                deleteSelectedAttBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            }
        }

        if (selectAllAtt) {
            selectAllAtt.addEventListener('change', (e) => {
                document.querySelectorAll('.att-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateAttendanceActionButtons();
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('att-row-checkbox')) {
                    updateAttendanceActionButtons();
                }
            });
        }

        if (deleteSelectedAttBtn) {
            deleteSelectedAttBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.att-row-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                showSupervisorDeleteModal(selectedIds.length, () => {
                    const selectedSet = new Set(selectedIds);
                    let data = getAttendanceData();
                    data = data.filter(item => !selectedSet.has(item.id));
                    saveAttendanceData(data);
                    renderAttendanceTable();
                    updateAttendanceActionButtons();
                    showToast(`${selectedIds.length} attendance records deleted`);
                });
            });
        }

        function showSupervisorDeleteModal(count, callback) {
            if (!supervisorDeleteModal) return;
            document.getElementById('supervisor-delete-count').textContent = count;
            document.getElementById('supervisor-code').value = '';
            supervisorDeleteCallback = callback;
            supervisorDeleteModal.classList.remove('hidden');
        }

        if (confirmSupervisorDeleteBtn) {
            confirmSupervisorDeleteBtn.addEventListener('click', () => {
                const code = document.getElementById('supervisor-code').value;
                if (code !== '12345' && code !== 'admin') { alert('Invalid Supervisor Code.'); return; }
                if (typeof supervisorDeleteCallback === 'function') supervisorDeleteCallback();
                supervisorDeleteModal.classList.add('hidden');
            });
        }

        // Export CSV
        if (exportAttBtn) {
            exportAttBtn.addEventListener('click', () => {
                const data = getFilteredAttendanceData();
                if (data.length === 0) { alert('No attendance records to export.'); return; }
                const headers = ['Date', 'User ID', 'Shift', 'Name', 'Role', 'Job Description', 'Time In', 'Break Out', 'Break In', 'Time Out', 'Duration', 'Status', 'Notes'];
                const rows = [headers.join(',')];
                
                data.forEach(item => {
                    const dur = getDuration(item.breakOut, item.breakIn);
                    const row = [
                        item.date, `"${item.userId||''}"`, `"${item.shift}"`, `"${item.name}"`, item.role || '', item.area || '', item.timeIn || '', item.breakOut || '', item.breakIn || '', item.timeOut || '', dur, `"${item.status||''}"`, `"${item.notes||''}"`
                    ];
                    rows.push(row.join(','));
                });
                
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'attendance_sheet.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }

        // Print
        if (printAttBtn) {
            printAttBtn.addEventListener('click', () => {
                const dataToPrint = getFilteredAttendanceData();
                if (dataToPrint.length === 0) {
                    alert('No records to print.');
                    return;
                }

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Attendance Report</title>');
                printWindow.document.write('<style>@page { size: letter landscape; margin: 0.25in; } body{font-family:sans-serif;font-size:11px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ccc;padding:4px;text-align:left;} th{background:#f0f0f0;} .sig{height:30px;}</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h2>Attendance Report</h2>');
                printWindow.document.write(`<p>Generated: ${new Date().toLocaleString()}</p>`);
                printWindow.document.write('<table><thead><tr>');
                const headers = ['Date', 'User ID', 'Shift', 'Name', 'Role', 'Job Description', 'Time In', 'Break Out', 'Break In', 'Time Out', 'Status', 'Notes', 'Signature'];
                headers.forEach(h => printWindow.document.write(`<th>${h}</th>`));
                printWindow.document.write('</tr></thead><tbody>');

                dataToPrint.forEach(item => {
                    printWindow.document.write('<tr>');
                    printWindow.document.write(`<td>${item.date}</td>`);
                    printWindow.document.write(`<td>${item.userId || ''}</td>`);
                    printWindow.document.write(`<td>${item.shift}</td>`);
                    printWindow.document.write(`<td>${item.name}</td>`);
                    printWindow.document.write(`<td>${item.role || '-'}</td>`);
                    printWindow.document.write(`<td>${item.area || '-'}</td>`);
                    printWindow.document.write(`<td>${item.timeIn || ''}</td>`);
                    printWindow.document.write(`<td>${item.breakOut || ''}</td>`);
                    printWindow.document.write(`<td>${item.breakIn || ''}</td>`);
                    printWindow.document.write(`<td>${item.timeOut || ''}</td>`);
                    printWindow.document.write(`<td>${item.status || ''}</td>`);
                    printWindow.document.write(`<td>${item.notes || ''}</td>`);
                    printWindow.document.write('<td class="sig"></td>');
                    printWindow.document.write('</tr>');
                });

                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<script>window.onload=function(){window.print();window.close();}<\/script>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
            });
        }

        // Requirements Modal Logic
        if(setReqBtn) {
            setReqBtn.addEventListener('click', () => {
                const reqs = loadRequirements();
                const tbody = document.querySelector('#req-table tbody');
                const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
                const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
                const roleFilter = document.getElementById('req-role-filter');
                
                // Populate filter
                if(roleFilter && roleFilter.options.length <= 1) {
                    subRolesList.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r;
                        opt.textContent = r;
                        roleFilter.appendChild(opt);
                    });
                }
                
                // Add Total Column Header if missing
                const theadRow = document.querySelector('#req-table thead tr');
                if (theadRow && theadRow.children.length === 4) {
                    const th = document.createElement('th');
                    th.textContent = 'Total';
                    theadRow.appendChild(th);
                }

                tbody.innerHTML = '';
                subRolesList.forEach(role => {
                    const tr = document.createElement('tr');
                    tr.dataset.role = role;
                    let html = `<td>${role}</td>`;
                    let rowTotal = 0;
                    shiftsList.forEach(shift => {
                        const key = `${role}|${shift}`;
                        const val = reqs[key] || 0;
                        rowTotal += val;
                        html += `<td><input type="number" class="req-input" data-key="${key}" value="${val}" style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;"></td>`;
                    });
                    html += `<td class="row-total" style="font-weight:bold; text-align:center;">${rowTotal}</td>`;
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });

                // Footer for Grand Totals
                let tfoot = document.querySelector('#req-table tfoot');
                if(!tfoot) {
                    tfoot = document.createElement('tfoot');
                    document.getElementById('req-table').appendChild(tfoot);
                }

                const updateTotals = () => {
                    let col1 = 0, col2 = 0, col3 = 0;
                    document.querySelectorAll('.req-input').forEach(inp => {
                        const val = parseInt(inp.value) || 0;
                        const key = inp.dataset.key;
                        if(key.includes('1st Shift')) col1 += val;
                        if(key.includes('2nd Shift')) col2 += val;
                        if(key.includes('3rd Shift')) col3 += val;
                        
                        // Update row total
                        const row = inp.closest('tr');
                        let rTotal = 0;
                        row.querySelectorAll('.req-input').forEach(ri => rTotal += (parseInt(ri.value)||0));
                        row.querySelector('.row-total').textContent = rTotal;
                    });
                    const grand = col1 + col2 + col3;
                    tfoot.innerHTML = `<tr style="background:#f0f0f0; font-weight:bold;"><td>Grand Total</td><td>${col1}</td><td>${col2}</td><td>${col3}</td><td style="text-align:center;">${grand}</td></tr>`;
                };
                
                updateTotals();
                tbody.addEventListener('input', (e) => {
                    if(e.target.classList.contains('req-input')) updateTotals();
                });

                reqModal.classList.remove('hidden');
            });
        }

        const reqRoleFilter = document.getElementById('req-role-filter');
        if(reqRoleFilter) {
            reqRoleFilter.addEventListener('change', () => {
                const val = reqRoleFilter.value;
                const rows = document.querySelectorAll('#req-table tbody tr');
                rows.forEach(r => {
                    if(val === '' || r.dataset.role === val) r.style.display = '';
                    else r.style.display = 'none';
                });
            });
        }

        if(saveReqBtn) {
            saveReqBtn.addEventListener('click', () => {
                const inputs = document.querySelectorAll('.req-input');
                const reqs = {};
                inputs.forEach(inp => {
                    reqs[inp.dataset.key] = parseInt(inp.value) || 0;
                });
                localStorage.setItem('ims_att_requirements_v1', JSON.stringify(reqs));
                reqModal.classList.add('hidden');
                updateSummary();
                showToast('Requirements saved');
            });
        }

        if(exportReqBtn) {
            exportReqBtn.addEventListener('click', () => {
                const reqs = loadRequirements();
                const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
                const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
                
                const headers = ['Sub Role', '1st Shift', '2nd Shift', '3rd Shift'];
                const rows = [headers.join(',')];
                
                subRolesList.forEach(role => {
                    const row = [`"${role}"`];
                    shiftsList.forEach(shift => {
                        const key = `${role}|${shift}`;
                        row.push(reqs[key] || 0);
                    });
                    rows.push(row.join(','));
                });
                
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'attendance_requirements.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }

        if(importReqBtn) importReqBtn.addEventListener('click', () => importReqFile.click());

        if(importReqFile) {
            importReqFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    const lines = text.split(/\r?\n/);
                    const reqs = loadRequirements();
                    const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
                    let count = 0;
                    for(let i=1; i<lines.length; i++) {
                        const line = lines[i].trim();
                        if(!line) continue;
                        const parts = line.split(',').map(p => p.replace(/^"|"$/g, '').trim());
                        if(parts.length >= 4) {
                            const role = parts[0];
                            if(role) {
                                reqs[`${role}|${shiftsList[0]}`] = parseInt(parts[1]) || 0;
                                reqs[`${role}|${shiftsList[1]}`] = parseInt(parts[2]) || 0;
                                reqs[`${role}|${shiftsList[2]}`] = parseInt(parts[3]) || 0;
                                count++;
                            }
                        }
                    }
                    localStorage.setItem('ims_att_requirements_v1', JSON.stringify(reqs));
                    alert(`Imported requirements for ${count} roles.`);
                    importReqFile.value = '';
                    if(setReqBtn) setReqBtn.click(); // Refresh modal
                };
                reader.readAsText(file);
            });
        }

        // Analysis Dashboard Logic
        function renderSubRoleDashboard() {
            const container = document.getElementById('sub-role-dashboard');
            if (!container) return;
            
            const data = getFilteredAttendanceData(true); // Ignore shift tab
            const shifts = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
            const subRoles = [...new Set(data.map(d => d.area).filter(Boolean))].sort();
            
            let html = `
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
            `;
            
            // Summary Cards for Analysis
            const total = data.length;
            const shiftCounts = {};
            shifts.forEach(s => shiftCounts[s] = data.filter(d => d.shift === s).length);
            
            shifts.forEach(s => {
                const count = shiftCounts[s];
                const pct = total > 0 ? Math.round((count/total)*100) : 0;
                const label = s.split('-')[0];
                html += `
                <div class="summary-card" style="padding:10px;">
                    <div class="summary-value" style="font-size:20px;">${count} <span style="font-size:14px; color:#999;">(${pct}%)</span></div>
                    <div class="summary-label">${label}</div>
                </div>`;
            });
            
            html += `</div>
            <div style="overflow-x:auto;">
            <table class="report-table" style="width:100%;">
                <thead>
                    <tr>
                        <th>Sub Role</th>
                        <th>1st Shift</th>
                        <th>2nd Shift</th>
                        <th>3rd Shift</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            const shiftTotals = {
                "1st Shift-(6am-2pm)": 0,
                "2nd Shift-(2pm-10pm)": 0,
                "3rd Shift-(10pm-6am)": 0
            };

            subRoles.forEach(role => {
                let roleTotal = 0;
                html += `<tr><td style="font-weight:bold;">${role}</td>`;
                
                shifts.forEach(shift => {
                    const count = data.filter(d => d.shift === shift && d.area === role).length;
                    shiftTotals[shift] += count;
                    roleTotal += count;
                    // Make cell clickable to filter
                    const cursorStyle = count > 0 ? 'cursor:pointer; color:#2752a7; text-decoration:underline;' : '';
                    const clickAttr = count > 0 ? `onclick="filterByAnalysis('${role}', '${shift}')"` : '';
                    html += `<td style="${cursorStyle}" ${clickAttr}>${count}</td>`;
                });
                
                html += `<td style="font-weight:bold;">${roleTotal}</td></tr>`;
            });
            
            // Totals Row
            html += `<tr style="background-color:#f8f9fa; font-weight:bold; border-top:2px solid #ddd;">
                <td>TOTAL</td>`;
            shifts.forEach(shift => {
                html += `<td>${shiftTotals[shift]}</td>`;
            });
            html += `<td>${total}</td></tr>`;
            
            html += `</tbody></table></div>`;
            
            container.innerHTML = html;
        }

        let icMasterSortField = 'name';
        let icMasterSortDir = 'asc';
        let icMasterPage = 1;
        let icMasterRowsPerPage = 20;

        // IC Master Logic
        function renderIcMaster() {
            const tbody = document.querySelector('#ic-master-table tbody');
            const jobSelect = document.getElementById('ic-master-job');
            
            if(!tbody) return;
            
            // Populate Job Desc dropdown if needed
            if(jobSelect && jobSelect.options.length <= 1) {
                const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
                subRolesList.sort().forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = r;
                    jobSelect.appendChild(opt);
                });
            }

            tbody.innerHTML = '';
            let users = [];
            try { users = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
            
            // Filter for IC Support
            users = users.filter(u => u.role === 'IC Support');
            
            const term = icMasterSearch ? icMasterSearch.value.toLowerCase() : '';
            if(term) {
                users = users.filter(u => u.userId.toLowerCase().includes(term) || u.name.toLowerCase().includes(term));
            }
            
            // Sorting
            users.sort((a,b) => {
                let valA = (a[icMasterSortField] || '').toLowerCase();
                let valB = (b[icMasterSortField] || '').toLowerCase();
                if(valA < valB) return icMasterSortDir === 'asc' ? -1 : 1;
                if(valA > valB) return icMasterSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update Sort Icons
            document.querySelectorAll('#ic-master-table th.sortable .sort-icon').forEach(el => el.textContent = '');
            const activeTh = document.querySelector(`#ic-master-table th[data-sort="${icMasterSortField}"] .sort-icon`);
            if(activeTh) activeTh.textContent = icMasterSortDir === 'asc' ? '‚Üë' : '‚Üì';

            // Pagination
            const totalItems = users.length;
            const totalPages = Math.ceil(totalItems / icMasterRowsPerPage) || 1;
            if (icMasterPage > totalPages) icMasterPage = totalPages;
            if (icMasterPage < 1) icMasterPage = 1;
            
            const start = (icMasterPage - 1) * icMasterRowsPerPage;
            const paginatedUsers = users.slice(start, start + icMasterRowsPerPage);

            // Update Pagination Controls
            const pageInfo = document.getElementById('ic-master-page-info');
            const prevBtn = document.getElementById('ic-master-prev');
            const nextBtn = document.getElementById('ic-master-next');
            
            if(pageInfo) pageInfo.textContent = `Page ${icMasterPage} of ${totalPages} (${totalItems} users)`;
            if(prevBtn) prevBtn.disabled = icMasterPage <= 1;
            if(nextBtn) nextBtn.disabled = icMasterPage >= totalPages;
            
            if(paginatedUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px; color:#999;">No IC Support users found.</td></tr>';
                return;
            }
            
            paginatedUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.userId}</td><td>${u.name}</td><td>${u.role}</td><td>${u.jobDescription || ''}</td><td><button class="icon-btn edit-ic-master-btn" data-id="${u.userId}" title="Edit" style="padding:2px 6px;">‚úé</button></td>`;
                tbody.appendChild(tr);
            });
        }

        // Sort headers
        document.querySelectorAll('#ic-master-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if(icMasterSortField === field) {
                    icMasterSortDir = icMasterSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    icMasterSortField = field;
                    icMasterSortDir = 'asc';
                }
                renderIcMaster();
            });
        });

        // Pagination controls
        const icMasterPrev = document.getElementById('ic-master-prev');
        const icMasterNext = document.getElementById('ic-master-next');
        const icMasterRows = document.getElementById('ic-master-rows');

        if(icMasterPrev) icMasterPrev.addEventListener('click', () => {
            if(icMasterPage > 1) { icMasterPage--; renderIcMaster(); }
        });
        if(icMasterNext) icMasterNext.addEventListener('click', () => {
            icMasterPage++; renderIcMaster();
        });
        if(icMasterRows) icMasterRows.addEventListener('change', () => {
            icMasterRowsPerPage = parseInt(icMasterRows.value);
            icMasterPage = 1;
            renderIcMaster();
        });

        const saveIcMasterBtn = document.getElementById('save-ic-master-btn');
        if(saveIcMasterBtn) {
            saveIcMasterBtn.addEventListener('click', () => {
                const idInput = document.getElementById('ic-master-id');
                const nameInput = document.getElementById('ic-master-name');
                const roleInput = document.getElementById('ic-master-role');
                const jobInput = document.getElementById('ic-master-job');
                
                const id = idInput.value.trim().toUpperCase();
                const name = nameInput.value.trim().toUpperCase();
                const role = roleInput.value;
                const job = jobInput.value;
                
                if(!id || !name) { alert('User ID and Name are required.'); return; }
                
                let users = [];
                try { users = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                
                const existingIdx = users.findIndex(u => u.userId === id);
                if(existingIdx > -1) {
                    users[existingIdx] = { userId: id, name, role, jobDescription: job };
                    showToast('User updated');
                } else {
                    users.push({ userId: id, name, role, jobDescription: job });
                    showToast('User added');
                }
                
                localStorage.setItem('ims_master_users_v1', JSON.stringify(users));
                renderIcMaster();
                
                // Clear inputs
                idInput.value = '';
                nameInput.value = '';
                jobInput.value = '';
                roleInput.value = 'IC Support';
            });
        }

        const icMasterTable = document.getElementById('ic-master-table');
        if(icMasterTable) {
            icMasterTable.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-ic-master-btn');
                if(btn) {
                    const id = btn.dataset.id;
                    let users = [];
                    try { users = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                    const user = users.find(u => u.userId === id);
                    if(user) {
                        document.getElementById('ic-master-id').value = user.userId;
                        document.getElementById('ic-master-name').value = user.name;
                        document.getElementById('ic-master-role').value = user.role || 'IC Support';
                        document.getElementById('ic-master-job').value = user.jobDescription || '';
                    }
                }
            });
        }

        if(icMasterBtn) {
            icMasterBtn.addEventListener('click', () => {
                icMasterModal.classList.remove('hidden');
                renderIcMaster();
            });
        }

        if(icMasterSearch) {
            icMasterSearch.addEventListener('input', () => {
                icMasterPage = 1;
                renderIcMaster();
            });
        }

        // Quick Time In Logic
        const quickTimeInBtn = document.getElementById('quick-time-in-btn');
        const quickUserIdInput = document.getElementById('quick-user-id');
        const quickUserNameInput = document.getElementById('quick-user-name');
        const quickUserRoleInput = document.getElementById('quick-user-role');
        const quickClearBtn = document.getElementById('quick-clear-btn');
        const manualAddBtn = document.getElementById('manual-add-btn');

        if (manualAddBtn) {
            manualAddBtn.addEventListener('click', () => {
                if(addAttBtn) addAttBtn.click();
            });
        }

        if (quickTimeInBtn && quickUserIdInput) {
            quickUserIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') quickTimeInBtn.click();
            });

            if(quickClearBtn) {
                quickClearBtn.addEventListener('click', () => {
                    quickUserIdInput.value = '';
                    if(quickUserNameInput) quickUserNameInput.value = '';
                    if(quickUserRoleInput) quickUserRoleInput.value = '';
                    quickUserIdInput.focus();
                });
            }

            // Update Clock
            function updateQuickClock() {
                const el = document.getElementById('quick-widget-clock');
                if(el) el.textContent = new Date().toLocaleString();
            }
            setInterval(updateQuickClock, 1000);
            updateQuickClock();

            // Auto-populate Name/Role
            quickUserIdInput.addEventListener('input', () => {
                const val = quickUserIdInput.value.trim().toUpperCase();
                if (val) {
                    let masterUsers = [];
                    try { masterUsers = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                    const user = masterUsers.find(u => u.userId === val);
                    if (user) {
                        if(quickUserNameInput) quickUserNameInput.value = user.name || '';
                        if(quickUserRoleInput) quickUserRoleInput.value = user.role || '';
                    } else {
                        if(quickUserNameInput) quickUserNameInput.value = '';
                        if(quickUserRoleInput) quickUserRoleInput.value = '';
                    }
                } else {
                    if(quickUserNameInput) quickUserNameInput.value = '';
                    if(quickUserRoleInput) quickUserRoleInput.value = '';
                }
            });

            quickTimeInBtn.addEventListener('click', () => {
                const userId = quickUserIdInput.value.trim().toUpperCase();
                if (!userId) { showToast('Please enter User ID'); return; }

                let masterUsers = [];
                try { masterUsers = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                const user = masterUsers.find(u => u.userId === userId);

                if (!user) {
                    alert(`User ID ${userId} not found in IC Master List.`);
                    return;
                }

                const now = new Date();
                const shiftInfo = getShiftFromTimestamp(now.getTime());
                const date = shiftInfo.date;
                const shift = shiftInfo.shift;
                const timeIn = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});

                const attendance = getAttendanceData();
                const exists = attendance.find(a => a.date === date && a.shift === shift && a.userId === userId);

                if (exists) {
                    alert(`User ${user.name} is already timed in for ${shift} on ${date}.`);
                    quickUserIdInput.value = '';
                    return;
                }

                const newEntry = {
                    id: Date.now().toString(),
                    date: date,
                    shift: shift,
                    userId: user.userId,
                    name: user.name,
                    role: user.role || 'IC Support',
                    area: user.jobDescription || '', // Auto-fill Job Description from master
                    timeIn: timeIn,
                    breakOut: '',
                    breakIn: '',
                    timeOut: '',
                    status: 'Full-time',
                    notes: 'Quick Time In'
                };

                attendance.push(newEntry);
                saveAttendanceData(attendance);
                
                showToast(`Timed in: ${user.name}`);
                quickUserIdInput.value = '';
                if(quickUserNameInput) quickUserNameInput.value = '';
                if(quickUserRoleInput) quickUserRoleInput.value = '';
                
                renderAttendanceTable();
                if(flipContainer.classList.contains('flipped')) renderSubRoleDashboard();
            });
            
            // Make Widget Draggable
            const quickWidget = document.getElementById('quick-time-in-widget');
            const quickHeader = document.getElementById('quick-widget-header');
            if(quickWidget && quickHeader) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                quickHeader.onmousedown = dragMouseDown;

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    quickWidget.style.top = (quickWidget.offsetTop - pos2) + "px";
                    quickWidget.style.left = (quickWidget.offsetLeft - pos1) + "px";
                    quickWidget.style.bottom = "auto"; 
                    quickWidget.style.right = "auto";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }
        }

        // Helper for click interaction
        window.filterByAnalysis = function(role, shift) {
             // Apply Shift Filter
             const shiftTab = document.querySelector(`.att-tab[data-shift="${shift}"]`);
             if(shiftTab) shiftTab.click();
             
             // Apply Sub Role Filter (Multi-select)
             const checkboxes = document.querySelectorAll('.att-area-cb');
             let matched = false;
             checkboxes.forEach(cb => {
                 cb.checked = (cb.value === role);
                 if(cb.checked) matched = true;
             });
             
             // Update Dropdown Text
             const areaText = document.getElementById('att-filter-area-text');
             if(areaText) areaText.textContent = matched ? role : 'All Job Descriptions';
             
             // Trigger Render
             renderAttendanceTable();
             
             // Flip back to table
             const flipContainer = document.getElementById('attendance-flip-container');
             if(flipContainer) flipContainer.classList.remove('flipped');
        }

        // Event Listeners for Filters
        if (applyGlobalFilterBtn) applyGlobalFilterBtn.addEventListener('click', renderAttendanceTable);
        if (clearGlobalFilterBtn) clearGlobalFilterBtn.addEventListener('click', () => { globalStartDate.value = ''; globalEndDate.value = ''; renderAttendanceTable(); });
        if (attSearchInput) attSearchInput.addEventListener('input', renderAttendanceTable);
        if (document.getElementById('att-filter-status')) document.getElementById('att-filter-status').addEventListener('change', renderAttendanceTable);
        if (attFilterRole) attFilterRole.addEventListener('change', renderAttendanceTable);
        
        // Sub Role Multi-Select Logic
        const areaBtn = document.getElementById('att-filter-area-btn');
        const areaDropdown = document.getElementById('att-filter-area-dropdown');
        const areaApplyBtn = document.getElementById('att-filter-area-apply');
        const areaClearBtn = document.getElementById('att-filter-area-clear');
        const areaText = document.getElementById('att-filter-area-text');

        if(areaBtn && areaDropdown) {
            areaBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                areaDropdown.style.display = areaDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            document.addEventListener('click', (e) => {
                if (!areaBtn.contains(e.target) && !areaDropdown.contains(e.target)) {
                    areaDropdown.style.display = 'none';
                }
            });

            areaApplyBtn.addEventListener('click', () => {
                const checked = Array.from(document.querySelectorAll('.att-area-cb:checked')).map(cb => cb.value);
                areaText.textContent = checked.length === 0 ? 'All Job Descriptions' : (checked.length <= 2 ? checked.join(', ') : `${checked.length} Selected`);
                areaDropdown.style.display = 'none';
                renderAttendanceTable();
            });

            areaClearBtn.addEventListener('click', () => {
                document.querySelectorAll('.att-area-cb').forEach(cb => cb.checked = false);
                areaText.textContent = 'All Job Descriptions';
                areaDropdown.style.display = 'none';
                renderAttendanceTable();
            });
        }

        // Flip Card Listeners
        if(viewChartBtn && flipContainer) {
            viewChartBtn.addEventListener('click', () => {
                flipContainer.classList.add('flipped');
                renderSubRoleDashboard();
            });
        }
        if(viewTableBtn && flipContainer) {
            viewTableBtn.addEventListener('click', () => flipContainer.classList.remove('flipped'));
        }
        
        // Tab Listeners
        document.querySelectorAll('.att-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.att-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentShiftFilter = tab.dataset.shift;
                renderAttendanceTable();
            });
        });

        // Attendance Sorting Listeners
        document.querySelectorAll('#attendance-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (attSortField === field) {
                    attSortDirection = attSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    attSortField = field;
                    attSortDirection = 'asc';
                }
                renderAttendanceTable();
            });
        });

        // Pagination Listeners
        const attPaginationControls = document.getElementById('att-pagination-controls');
        if (attPaginationControls) {
            attPaginationControls.addEventListener('click', (e) => {
                if (e.target.id === 'att-prev-page' && !e.target.disabled) {
                    attCurrentPage--;
                    renderAttendanceTable();
                } else if (e.target.id === 'att-next-page' && !e.target.disabled) {
                    attCurrentPage++;
                    renderAttendanceTable();
                }
            });
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) {
                attRowsPerPageSelect.addEventListener('change', () => {
                    attCurrentPage = 1;
                    renderAttendanceTable();
                });
            }
        }

        // Modal Close
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal) modal.classList.add('hidden');
            });
        });
        
        // Set Current Time Button
        if (attModal) {
            attModal.addEventListener('click', (e) => {
                const btn = e.target.closest('.set-current-time');
                if (btn) {
                    const targetId = btn.dataset.target;
                    const targetInput = document.getElementById(targetId);
                    if (targetInput) {
                        const now = new Date();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        targetInput.value = `${hours}:${minutes}`;
                    }
                }
            });
        }

        // Auto Refresh
        setInterval(() => {
            const check = document.getElementById('auto-refresh-check');
            if(check && check.checked) {
                if(document.querySelector('.modal:not(.hidden)')) return;
                renderAttendanceTable();
            }
        }, 15000);

        // Initial Render
        renderAttendanceTable();
    });
  </script>
</body>
</html>
